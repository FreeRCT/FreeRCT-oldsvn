\documentclass{article}
% $Id$
% This file is part of FreeRCT.
% FreeRCT is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, version 2.
% FreeRCT is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
% See the GNU General Public License for more details. You should have received a copy of the GNU General Public License along with FreeRCT. If not, see <http://www.gnu.org/licenses/>.
%
\usepackage[a4paper]{geometry}
\title{File format of the \texttt{$*$.rcd} data files}
\author{Alberth}
\date{Version 1}

\begin{document}
\maketitle

%%
%%
%%
\section{File header}
Each data file starts with a file header indicating it is a RCD{} file.
The format is as follows

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
0 & 4 & Magic string `RCDF' \\
4 & 4 & Value `1', version number of the data file format. \\ \hline
8 & \multicolumn{2}{l|}{Total length} \\ \hline
\end{tabular}
\end{center}

%%
%%
%%
\section{Data blocks}
After the file header come the various data blocks.
The goal of data blocks is to provide blobs of information that are somewhat independent.
The data blocks are referenced by game blocks by their ID. The first data block
gets number 1, the second block number 2, etc.

A reference to data block 0 means `not present'.

\subsection{Palette data block}
A data block stating the palette of a 8bpp image.

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
 0 & 4 & Magic string `8PAL' \\
 4 & 4 & Version number of the block `1'. \\
 8 & 4 & Length of the block excluding magic string, version, and length. \\
12 & 2 & \textit{count}, number of palette entries (should be at least 1 and at most 256). \\
14 & 3*\textit{count} & Palette data, 3 bytes RGB{} data for each entry. \\ \hline
 ? & \multicolumn{2}{l|}{Variable length} \\ \hline
\end{tabular}
\end{center}



\subsection{Sprite Pixels}
A data block containing the actual image of a sprite (in 8bpp).

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
 0 & 4 & Magic string `8PXL' \\
 4 & 4 & Version number of the block `1'. \\
 8 & 4 & Length of the block excluding magic string, version, and length. \\
12 & 2 & Width of the image. \\
14 & 2 & $h$, height of the image. \\
16 & $4*h$ & jump table to start of pixel data of each line. Offset is relative to the first \\
   &       & entry of the jump table. Value 0 means there is no data for that line. \\
 ? &    ?  & Pixels of each line. \\ \hline
 ? & \multicolumn{2}{l|}{Variable length} \\ \hline
\end{tabular}
\end{center}

Line data is a sequence of pixels with an offset. Its format is

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
 0 & 1 & Relative offset (0-127), bit 7 means `last entry of the line'. \\
 1 & 1 & $n$, number of pixels that follow this count (0-255). \\
 2 & $n$ & Pixels, 1 byte per pixel (as it is 8bpp). \\ \hline
 ? & \multicolumn{2}{l|}{Variable length} \\ \hline
\end{tabular}
\end{center}

The offset byte is relative to the end of the previous pixels, thus an offset
of 0 means no gap between the pixels. A count of 0 is useful if the gap at a
line is longer than 127 pixels.

\medskip
Note: Some simple form of compressing may be useful in the pixels as it
decreases the amount of memory transfers.


\subsection{Sprite block}
Data of a single sprite.

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
 0 & 4 & Magic string `SPRT' \\
 4 & 4 & Version number of the block `1'. \\
 8 & 4 & Length of the block excluding magic string, version, and length. \\
12 & 2 & (signed) X-offset. \\
14 & 2 & (signed) Y-offset. \\
16 & 4 & Sprite image data. \\
18 & 4 & Palette data. \\ \hline
22 & \multicolumn{2}{l|}{Total length} \\ \hline
\end{tabular}
\end{center}


\section{Game blocks}
A game block is a piece of data useful for the game. Normally it refers to one
or more data blocks.

\subsection{Ground tiles block}
A set of ground tiles that form a smooth surface.

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
  0 & 4 & Magic string `SURF' \\
  4 & 4 & Version number of the block `2'. \\
  8 & 4 & Length of the block excluding magic string, version, and length. \\
 12 & 2 & (added in version 2) Type of ground. \\
 14 & 2 & Width of a tile of the surface. \\
 16 & 2 & Change in Z height (in pixels) when going up or down a tile level. \\
 18 & 76 & 19 sprite block references for the tile when viewing towards north. \\
 94 & 76 & 19 sprite block references for the tile when viewing towards east.  \\
170 & 76 & 19 sprite block references for the tile when viewing towards south. \\
246 & 76 & 19 sprite block references for the tile when viewing towards west.  \\ \hline
322 & \multicolumn{2}{l|}{Total length} \\ \hline
\end{tabular}
\end{center}

Known types of ground:
\begin{itemize}
\item Empty (0) Reserved, do not use in the RCD{} file.
\item Grass (16-19) Green grass gound, with increasing length grass on it.
\item Sand  (32) Desert `ground'.
\end{itemize}

The 19 sprite entries of a view contain

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
 0 & 4 & Flat surface tile. \\
 4 & 4 & North corner up. \\
 8 & 4 & East corner up. \\
12 & 4 & North, east corners up. \\
16 & 4 & South corner up. \\
20 & 4 & North, south corners up. \\
24 & 4 & East, south corners up. \\
28 & 4 & North, east, south corners up. \\
32 & 4 & West, north corners up. \\
36 & 4 & West, east corners up. \\
40 & 4 & West, north, east corners up. \\
44 & 4 & West, south corners up. \\
48 & 4 & West, north, south corners up. \\
52 & 4 & West, east, south corners up. \\
56 & 4 & Steep north slope. \\
64 & 4 & Steep east slope. \\
72 & 4 & Steep south slope. \\
76 & 4 & Steep west slope. \\ \hline
\end{tabular}
\end{center}
Note that this entries are about \textit{real} (unrotated) corners. In other
words, at a given tile the same entry is used independent of the view
orientation.

Note: \textit{Whether this is a sane decision remains to be seen, it is
probably not clear until rendering of multi-tile pieces is implemented.}

\subsection{Foundations block}
Vertical foundations to close gaps in the smooth surface.

\begin{center}
\begin{tabular}{|r|c|l|} \hline
\textbf{Offset} & \textbf{Length} & \textbf{Contents description} \\ \hline
  0 &  4 & Magic string `FUND' \\
  4 &  4 & Version number of the block `1'. \\
  8 &  4 & Length of the block excluding magic string, version, and length. \\
 12 &  2 & Type of foundation. \\
 14 &  2 & Width of a tile. \\
 16 &  2 & Change in Z height of the tiles. \\
 18 &  4 & Vertical south-east foundation, east up, south down. \\
 22 &  4 & Vertical south-east foundation, east down, south up. \\
 26 &  4 & Vertical south-east foundation, east up, south up. \\
 30 &  4 & Vertical south-west foundation, south up, west down. \\
 34 &  4 & Vertical south-west foundation, south down, west up. \\
 38 &  4 & Vertical south-west foundation, south up, west up. \\ \hline
 42 & \multicolumn{2}{l|}{Total length} \\ \hline
\end{tabular}
\end{center}

Known types of foundation:
\begin{itemize}
\item Empty (0) Reserved, do not use in the RCD{} file.
\item Ground (16)
\item Wood (32)
\item Brick (48)
\end{itemize}

The tile width and z-height are used to ensure the foundations match with the
surface tiles.

%%
%%
%%
\newpage
\section{Future}

To consider:
\begin{itemize}
\item Place for the license
\item Author and other information?
\item Readme document?
\item \ldots?
\end{itemize}

To do:
\begin{itemize}
\item (nothing, at the moment)
\end{itemize}

\end{document}

%vim: set spell
